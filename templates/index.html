{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-bold mb-6">üìä Messsystem-Konfiguration</h1>

<div id="messageBox" class="hidden mb-4"></div>

<form id="configForm" onsubmit="saveConfig(event)" class="bg-white p-6 rounded-xl shadow space-y-4">

<!-- Globale Einstellungen -->
<div class="bg-white p-6 rounded-xl shadow mb-6">
  <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Allgemeine Einstellungen</h2>
  {% for key, val in config.items() %}
    {% if key in ["MESSINTERVAL", "ADMIN_PIN"] %}
      <div class="mb-4">
        <label class="block font-semibold text-gray-700 mb-1">{{ key }}</label>
        <input name="{{ key }}" value="{{ val }}" class="border p-2 w-full rounded focus:ring-2 focus:ring-blue-400 outline-none" />
        <p class="text-gray-500 text-sm mt-1">{{ descriptions.get(key) }}</p>
      </div>
    {% endif %}
  {% endfor %}
</div>

<!-- BMP280 Barometer -->
<div class="bg-white p-6 rounded-xl shadow mb-6">
  <h2 class="text-xl font-bold mb-4">üå°Ô∏è Barometer (BMP280)</h2>
  <div class="mb-4">
    <label class="block font-semibold text-gray-700 mb-1">BMP280_ENABLED</label>
    <select name="BMP280_ENABLED" class="border p-2 w-full rounded focus:ring-2 focus:ring-blue-400 outline-none">
      <option value="True" {% if config.get("BMP280_ENABLED") %}selected{% endif %}>Aktiviert</option>
      <option value="False" {% if not config.get("BMP280_ENABLED") %}selected{% endif %}>Deaktiviert</option>
    </select>
    <p class="text-gray-500 text-sm mt-1">{{ descriptions.get("BMP280_ENABLED") }}</p>
  </div>
  <div class="mb-4">
    <label class="block font-semibold text-gray-700 mb-1">BMP280_ADDRESS</label>
    <input name="BMP280_ADDRESS" value="{{ config.get('BMP280_ADDRESS', '0x76') }}" class="border p-2 w-full rounded focus:ring-2 focus:ring-blue-400 outline-none" />
    <p class="text-gray-500 text-sm mt-1">{{ descriptions.get("BMP280_ADDRESS") }}</p>
  </div>
  <div class="mb-4">
    <label class="block font-semibold text-gray-700 mb-1">NAME_BMP280</label>
    <input name="NAME_BMP280" value="{{ config.get('NAME_BMP280', 'Barometer') }}" class="border p-2 w-full rounded focus:ring-2 focus:ring-blue-400 outline-none" />
    <p class="text-gray-500 text-sm mt-1">{{ descriptions.get("NAME_BMP280") }}</p>
  </div>
</div>

<!-- Analoge Kan√§le -->
{% set colors = ["bg-blue-50", "bg-green-50", "bg-yellow-50", "bg-purple-50"] %}
{% for channel in ["A0", "A1", "A2", "A3"] %}
  <div class="{{ colors[loop.index0] }} border p-6 rounded-xl shadow mb-6">
    <h2 class="text-xl font-bold mb-4">üíß Kanal {{ channel }} ‚Äì {{ config.get("NAME_" + channel, "unbenannt") }}</h2>

    {% for key, val in config.items() %}
      {% if key.endswith("_" + channel) and not key.startswith("SHUNT_OHMS") %}
        <div class="mb-4">
          <label class="block font-semibold text-gray-700 mb-1">{{ key }}</label>
          {% if "SENSOR_TYP" in key %}
              <select name="{{ key }}" class="border p-2 w-full rounded focus:ring-2 focus:ring-blue-400 outline-none">
                <option value="LEVEL" {% if val == "LEVEL" %}selected{% endif %}>Wasserlevel</option>
                <option value="TEMP" {% if val == "TEMP" %}selected{% endif %}>Temperatur</option>
                <option value="FLOW" {% if val == "FLOW" %}selected{% endif %}>Durchfluss</option>
                <option value="ANALOG" {% if val == "ANALOG" %}selected{% endif %}>Analog</option>
              </select>

            {% elif "SENSOR_EINHEIT" in key %}
              <select name="{{ key }}" class="border p-2 w-full rounded focus:ring-2 focus:ring-blue-400 outline-none">
                <option value="m" {% if val == "m" %}selected{% endif %}>m</option>
                <option value="cm" {% if val == "cm" %}selected{% endif %}>cm</option>
                <option value="mm" {% if val == "mm" %}selected{% endif %}>mm</option>

                <option value="¬∞C" {% if val == "¬∞C" %}selected{% endif %}>¬∞C</option>
                <option value="K" {% if val == "K" %}selected{% endif %}>K</option>

                <option value="m3/h" {% if val == "m3/h" %}selected{% endif %}>m¬≥/h</option>
                <option value="l/min" {% if val == "l/min" %}selected{% endif %}>l/min</option>
                <option value="l/s" {% if val == "l/s" %}selected{% endif %}>l/s</option>

                <option value="" {% if val == "" %}selected{% endif %}>(keine)</option>
              </select>

            {% else %}
              <input 
                name="{{ key }}" 
                value="{{ val }}" 
                class="border p-2 w-full rounded focus:ring-2 focus:ring-blue-400 outline-none" 
              />
            {% endif %}

          {% if descriptions.get(key) %}
            <p class="text-gray-500 text-sm mt-1">{{ descriptions.get(key) }}</p>
          {% endif %}
        </div>
      {% endif %}
    {% endfor %}
  </div>
{% endfor %}

  <button type="submit" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
    üíæ √Ñnderungen speichern
  </button>
</form>

<script>
async function saveConfig(event) {
  event.preventDefault();
  const form = document.getElementById('configForm');
  const formData = new FormData(form);
  const box = document.getElementById("messageBox");

  try {
    const response = await fetch('{{ url_for("update_config") }}', { method: 'POST', body: formData });
    const result = await response.json();

    box.classList.remove("hidden");
    box.textContent = result.message;
    box.className = result.success
      ? "p-3 rounded bg-green-100 text-green-800 border border-green-400"
      : "p-3 rounded bg-red-100 text-red-800 border border-red-400";
    window.scrollTo({ top: 0, behavior: "smooth" });
  } catch (err) {
    box.classList.remove("hidden");
    box.textContent = "‚ùå Netzwerkfehler oder Serverproblem: " + err;
    box.className = "p-3 rounded bg-red-100 text-red-800 border border-red-400";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
}
</script>
{% endblock %}
