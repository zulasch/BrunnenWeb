{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">⚙️ Dienstverwaltung</h1>

<div class="grid grid-cols-1 md:grid-cols-2 gap-4">

  <!-- Logger-Dienst -->
  <div class="bg-white p-5 shadow rounded">
    <h2 class="font-semibold text-lg mb-2">📘 Logger-Dienst</h2>
    <p class="text-gray-600 mb-3">Erfasst und speichert aktuelle Messwerte.</p>
    <button id="restart-logger" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">
      🔁 Logger neu starten
    </button>
  </div>

  <!-- WebApp-Dienst -->
  <div class="bg-white p-5 shadow rounded">
    <h2 class="font-semibold text-lg mb-2">💻 WebApp-Dienst</h2>
    <p class="text-gray-600 mb-3">Steuert das Webinterface und die Benutzeroberfläche.</p>
    <button id="restart-web" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 w-full">
      🔄 WebApp neu starten
    </button>
  </div>

  <!-- GitHub Update -->
  <div class="bg-white p-5 shadow rounded md:col-span-2">
    <h2 class="font-semibold text-lg mb-2">🌀 GitHub-Update</h2>
    <p class="text-gray-600 mb-3">
      Lade automatisch die neuesten Änderungen deines Messsystems aus GitHub herunter und aktualisiere die Umgebung.
    </p>
    <button id="updateBtn" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 w-full">
      ⬆️ Update starten
    </button>
  </div>

</div>

<div id="service-result" class="mt-6 text-center"></div>
<div id="updateStatus" class="mt-4 p-3 rounded hidden"></div>

<script>
async function restartService(service) {
  const btn = document.getElementById(`restart-${service}`);
  const resultBox = document.getElementById("service-result");
  btn.disabled = true;
  btn.textContent = "⏳ Neustart läuft...";
  resultBox.innerHTML = "";

  try {
    const formData = new FormData();
    formData.append("service", service);
    formData.append("action", "restart");

    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 5000); // 5s Timeout

    const response = await fetch("/service/action", {
      method: "POST",
      body: formData,
      signal: controller.signal
    });
    clearTimeout(timeout);

    // Versuch, JSON zu parsen (wenn WebApp sich noch nicht beendet hat)
    const data = await response.json().catch(() => null);

    if (response.ok && data && data.status === "ok") {
      resultBox.innerHTML = `<div class='bg-green-100 text-green-800 p-3 rounded'>${data.message}</div>`;
    } else {
      // Fallback wenn kein JSON oder Response abbricht
      throw new Error("Keine Antwort erhalten.");
    }

  } catch (err) {
    // 💡 Wenn WebApp neu gestartet wird, bricht fetch ab → simuliertes "Erfolg"
    if (service === "web") {
      resultBox.innerHTML = `
        <div class='bg-yellow-100 text-yellow-800 p-3 rounded'>
          🔄 Die WebApp wird jetzt neu gestartet.<br>
          Bitte warte 5–10 Sekunden, dann <b>lade die Seite neu</b>.
        </div>`;
      // optionaler Auto-Reload nach 8s
      setTimeout(() => location.reload(), 8000);
    } else {
      resultBox.innerHTML =
        `<div class='bg-red-100 text-red-800 p-3 rounded'>❌ Fehler: ${err.message || err}</div>`;
    }
  } finally {
    btn.disabled = false;
    btn.textContent =
      service === "logger" ? "🔁 Logger neu starten" : "🔄 WebApp neu starten";
  }
}
</script>

{% endblock %}
